<!doctype html>
<html lang="az">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Ä°stehsalat ÆmÉ™liyyatÄ±</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        .container { padding-top: 20px }
        .card-header { font-weight: 600 }
        .input-row, .output-row { align-items: center }
        .w-25 { min-width: 100px }
        .form-control-sm { padding-right: 5px }
        /* Disabled input Ã¼Ã§Ã¼n stil */
        .disabled-input {
            background-color: #f8f9fa !important;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>ğŸ­ Ä°stehsalat / XammalÄ±n HazÄ±r MÉ™hsula Ã‡evrilmÉ™si</h2>
            <a href="{{ url_for('production_report') }}" class="btn btn-info btn-lg">
                <i class="fas fa-file-alt"></i> Hesabatlar
            </a>
        </div>
        <p class="text-muted">Anbardan xammal Ã§Ä±xarÄ±lÄ±r vÉ™ onun É™vÉ™zinÉ™ hazÄ±r mÉ™hsullar anbara daxil edilir.</p>
        <hr>
        
        
        {% with messages = get_flashed_messages(with_categories=true) %}{% if messages %}{% for category, message in
        messages %}<div class="alert alert-{{ category }}">{{ message }}</div>{% endfor %}{% endif %}{% endwith %}
        
        <form method="POST" action="{{ url_for('handle_production') }}">
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">Xammal (Anbardan Ã‡Ä±xÄ±r)</div>
                        <div class="card-body" id="input-items-container">
                            <p class="text-muted">Æn azÄ± bir xammal daxil edin.</p>
                        </div>
                        <div class="card-footer">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="addInputBtn">+ Xammal ÆlavÉ™ Et</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-header bg-success text-white">HazÄ±r MÉ™hsul (Anbara Daxil Olur)</div>
                        <div class="card-body" id="output-items-container">
                            <p class="text-muted">Æn azÄ± bir hazÄ±r mÉ™hsul daxil edin.</p>
                        </div>
                        <div class="card-footer">
                            <button type="button" class="btn btn-sm btn-outline-success" id="addOutputBtn">+ MÉ™hsul ÆlavÉ™ Et</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-group mb-3">
                <label for="description">Qeyd / TÉ™svir:</label>
                <textarea class="form-control" id="description" name="description" rows="3"></textarea>
            </div>
            
            <script>
                const productionUrl = "{{ url_for('index') }}";
            </script>
            
            <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-outline-secondary btn-lg" onclick="window.location.href=productionUrl;">
                    â† Geri QayÄ±t
                </button>
                <button type="submit" class="btn btn-lg btn-success">âœ… Ä°stehsalat ÆmÉ™liyyatÄ±nÄ± Tamamla</button>
            </div>
        </form>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const products = JSON.parse('{{ products|tojson|safe }}' || '[]');
            
            const productMap = products.reduce((acc, p) => {
                acc[p.id] = p;
                return acc;
            }, {});

            function generateOptions() {
                return products.map(p => `<option value="${p.id}">${p.name} (${p.unit}) [Stok: ${p.stock}]</option>`).join('');
            }

            function getUnitOptions(selectedValue = 'É™dÉ™d') {
                const units = ["É™dÉ™d", "kq", "ton", "litr", "metr", "metr kvadrat", "metr kub", "rulu", "qablaÅŸdÄ±rma", "dÉ™st", "qutu", "baÄŸlama", "paket"];
                return units.map(unit => 
                    `<option value="${unit}" ${unit === selectedValue ? 'selected' : ''}>${unit}</option>`
                ).join('');
            }

            // HazÄ±r mÉ™hsul sÉ™tri Ã¼Ã§Ã¼n mÉ™ntiqin tÉ™tbiqi (toggle) - YENÄ° DÃœZÆLÄ°Å
            function applyOutputProductLogic(row) {
                const selectElement = row.querySelector('[name="output_product_id[]"]');
                const nameInputElement = row.querySelector('[name="output_new_product_name[]"]');
                const unitSelectElement = row.querySelector('[name="output_unit[]"]');
                const quantityInputElement = row.querySelector('[name="output_quantity[]"]'); 

                if (!selectElement || !nameInputElement || !unitSelectElement || !quantityInputElement) {
                    return;
                }
                
                // SahÉ™lÉ™rin cari vÉ™ziyyÉ™tini yenilÉ™yÉ™n É™sas funksiya
                function updateRowState() {
                    const selectedId = selectElement.value;
                    const nameWritten = nameInputElement.value.trim() !== "";
                    
                    // --- MÃ–VCUD MÆHSUL seÃ§ilib ---
                    if (selectedId && selectedId !== "") {
                        const product = productMap[selectedId];
                        const productUnit = product ? product.unit : 'É™dÉ™d';
                        
                        // Yeni AdÄ± deaktiv et vÉ™ tÉ™mizlÉ™
                        nameInputElement.value = "";
                        nameInputElement.disabled = true;
                        nameInputElement.required = false;
                        nameInputElement.classList.add('disabled-input');
                        nameInputElement.placeholder = 'MÃ¶vcud mÉ™hsul seÃ§ilib';

                        // Vahidi mÉ™hsulun vahidi ilÉ™ É™vÉ™z et vÉ™ deaktiv et
                        unitSelectElement.innerHTML = getUnitOptions(productUnit);
                        unitSelectElement.disabled = true;
                        unitSelectElement.classList.add('disabled-input');
                        
                        // MiqdarÄ± aktiv et
                        quantityInputElement.disabled = false;
                        quantityInputElement.required = true;
                        quantityInputElement.classList.remove('disabled-input');

                        // ID seÃ§imini aktiv saxla
                        selectElement.disabled = false;
                        selectElement.classList.remove('disabled-input');

                    } 
                    // --- YENÄ° MÆHSUL adÄ± yazÄ±lÄ±b ---
                    else if (nameWritten) {
                        
                        // ID seÃ§imini tÉ™mizlÉ™, deaktiv et
                        selectElement.value = "";
                        selectElement.disabled = true;
                        selectElement.classList.add('disabled-input');

                        // Yeni AdÄ±, Vahidi vÉ™ MiqdarÄ± aktiv et
                        nameInputElement.disabled = false;
                        nameInputElement.required = true;
                        nameInputElement.classList.remove('disabled-input');
                        nameInputElement.placeholder = 'Yeni mÉ™hsulun adÄ± (mÉ™cburi)';
                        
                        unitSelectElement.disabled = false;
                        unitSelectElement.classList.remove('disabled-input');
                        unitSelectElement.innerHTML = getUnitOptions(unitSelectElement.value || 'É™dÉ™d');

                        quantityInputElement.disabled = false;
                        quantityInputElement.required = true;
                        quantityInputElement.classList.remove('disabled-input');

                    } 
                    // --- HEÃ‡ BÄ°RÄ° SEÃ‡Ä°LMÆYÄ°B (Ä°lkin vÉ™ziyyÉ™t) ---
                    else {
                        // MiqdarÄ± deaktiv et
                        quantityInputElement.disabled = true;
                        quantityInputElement.required = false;
                        quantityInputElement.classList.add('disabled-input');
                        
                        // ID seÃ§imini vÉ™ Yeni Ad sahÉ™sini aktiv saxla
                        selectElement.disabled = false;
                        selectElement.classList.remove('disabled-input');
                        
                        nameInputElement.disabled = false;
                        nameInputElement.required = true;
                        nameInputElement.classList.remove('disabled-input');
                        nameInputElement.placeholder = 'Yeni mÉ™hsulun adÄ± (mÉ™cburi)';
                        
                        unitSelectElement.disabled = false;
                        unitSelectElement.classList.remove('disabled-input');
                        unitSelectElement.innerHTML = getUnitOptions('É™dÉ™d');
                    }
                }
                
                // Event listenerlarÄ± yalnÄ±z updateRowState funksiyasÄ±nÄ± Ã§aÄŸÄ±rÄ±r
                selectElement.addEventListener('change', updateRowState);
                nameInputElement.addEventListener('input', updateRowState);
                
                // Ä°lkin yÃ¼klÉ™nmÉ™dÉ™ mÉ™ntiqi tÉ™tbiq et
                updateRowState();
            }

            function addInputRow() {
                const container = document.getElementById('input-items-container');
                const placeholder = container.querySelector('p.text-muted');
                if (placeholder) placeholder.remove();

                const div = document.createElement('div');
                div.className = 'd-flex mb-2 input-row';
                div.innerHTML = `<select class="form-control form-control-sm mr-2" name="input_product_id[]" required>
                    <option value="">-- XammalÄ± SeÃ§in --</option>${generateOptions()}
                    </select>
                    <input type="number" step="any" min="0.001" class="form-control form-control-sm mr-2 w-25" name="input_quantity[]" placeholder="Miqdar" required>
                    <button type="button" class="btn btn-sm btn-danger remove-btn">X</button>`;
                container.appendChild(div);
                div.querySelector('.remove-btn').addEventListener('click', () => div.remove());
            }

            function addOutputRow() {
                const container = document.getElementById('output-items-container');
                const placeholder = container.querySelector('p.text-muted');
                if (placeholder) placeholder.remove();

                const div = document.createElement('div');
                div.className = 'd-flex mb-2 output-row';
                div.innerHTML = `<select class="form-control form-control-sm mr-2" name="output_product_id[]">
                    <option value="">-- MÃ¶vcud MÉ™hsul SeÃ§ --</option>${generateOptions()}
                    </select>
                    <input type="text" class="form-control form-control-sm mr-2" style="min-width:150px;" name="output_new_product_name[]" placeholder="Yeni mÉ™hsulun adÄ± (mÉ™cburi)">
                    <select class="form-control form-control-sm mr-2 w-25" name="output_unit[]" style="min-width:100px;">
                        ${getUnitOptions()}
                    </select>
                    <input type="number" step="0.001" min="0.001" class="form-control form-control-sm mr-2 w-25" name="output_quantity[]" placeholder="Miqdar" required>
                    <button type="button" class="btn btn-sm btn-danger remove-btn">X</button>`;
                container.appendChild(div);

                applyOutputProductLogic(div); 

                div.querySelector('.remove-btn').addEventListener('click', () => div.remove());
            }

            // Form Submit MÉ™ntiqi (ServerÉ™ gÃ¶ndÉ™rilmÉ™zdÉ™n É™vvÉ™l son yoxlama vÉ™ tÉ™nzimlÉ™mÉ™)
            document.querySelector('form').addEventListener('submit', function(e) {
                let hasValidInput = false;
                let hasValidOutput = false;
                let outputErrors = [];
                
                const elementsToReEnable = [];

                // --- Input ValidasiyasÄ± ---
                document.querySelectorAll('#input-items-container .input-row').forEach((row) => {
                    const quantityInput = row.querySelector('input[name="input_quantity[]"]');
                    const selectElement = row.querySelector('select[name="input_product_id[]"]');
                    
                    if (selectElement.value && quantityInput.value.trim()) {
                        hasValidInput = true;
                        // Formatlama
                        quantityInput.value = quantityInput.value.trim().replace(',', '.');
                    } else {
                        row.querySelectorAll('input, select').forEach(el => {
                            if (!el.disabled) elementsToReEnable.push(el);
                            el.disabled = true;
                        });
                    }
                });
                
                // --- Output ValidasiyasÄ± vÉ™ Form DÉ™yÉ™rlÉ™rinin DÃ¼zÉ™ldilmÉ™si ---
                document.querySelectorAll('#output-items-container .output-row').forEach((row, index) => {
                    const selectElement = row.querySelector('[name="output_product_id[]"]');
                    const nameInput = row.querySelector('[name="output_new_product_name[]"]');
                    const unitSelect = row.querySelector('[name="output_unit[]"]');
                    const quantityInput = row.querySelector('[name="output_quantity[]"]');
                    
                    const nameValue = nameInput ? nameInput.value.trim() : '';
                    const quantityValue = quantityInput ? quantityInput.value.trim() : '';
                    
                    if (!quantityValue) {
                        row.querySelectorAll('input, select').forEach(el => {
                            if (!el.disabled) elementsToReEnable.push(el);
                            el.disabled = true;
                        });
                        return;
                    }

                    quantityInput.value = quantityValue.replace(',', '.');
                    const quantity = parseFloat(quantityInput.value);

                    if (isNaN(quantity) || quantity <= 0) {
                        outputErrors.push(`SÉ™tr ${index + 1}: Miqdar dÃ¼zgÃ¼n rÉ™qÉ™m formatÄ±nda deyil (sÄ±fÄ±rdan bÃ¶yÃ¼k olmalÄ±dÄ±r)!`);
                        return;
                    }
                    
                    const isExistingProductSelected = selectElement.value && selectElement.value !== '' && selectElement.value !== 'new';

                    if (nameValue && !isExistingProductSelected) {
                        // YENÄ° MÆHSUL
                        selectElement.value = 'new'; // ServerÉ™ 'new' gÃ¶ndÉ™rilmÉ™si Ã¼Ã§Ã¼n
                        selectElement.disabled = false; 
                        nameInput.disabled = false;
                        unitSelect.disabled = false;
                        hasValidOutput = true;
                    } else if (isExistingProductSelected && !nameValue) {
                        // MÃ–VCUD MÆHSUL
                        selectElement.disabled = false; 
                        nameInput.disabled = true; // Ad gÃ¶ndÉ™rilmÉ™mÉ™lidir
                        unitSelect.disabled = true; // Vahid mÃ¶vcud mÉ™hsulun vahididir
                        hasValidOutput = true;
                    } else if (nameValue && isExistingProductSelected) {
                        // ZÄ°DDÄ°YYÆT (Bu hal updateRowState tÉ™rÉ™findÉ™n idarÉ™ olunur, amma son yoxlama)
                        outputErrors.push(`SÉ™tr ${index + 1}: HÉ™m mÃ¶vcud mÉ™hsul seÃ§imi, hÉ™m dÉ™ yeni mÉ™hsul adÄ± daxil edilib. YalnÄ±z birini seÃ§in!`);
                        return;
                    } else {
                        outputErrors.push(`SÉ™tr ${index + 1}: Miqdar daxil edildiyi halda, mÉ™hsul seÃ§ilmÉ™yib/adÄ± daxil edilmÉ™yib!`);
                        return;
                    }

                    // GÃ¶ndÉ™rilmÉ™si Ã¼Ã§Ã¼n deaktiv edilmiÅŸ elementlÉ™ri (yalnÄ±z form elementlÉ™rini) aktiv et
                    row.querySelectorAll('input, select').forEach(el => {
                        if (el.name && (el.name.startsWith('output_') || el.name.startsWith('input_')) && el.disabled) {
                           elementsToReEnable.push(el);
                           el.disabled = false;
                        }
                    });
                });
                
                // XÉ™ta varsa, form tÉ™qdimatÄ±nÄ± dayandÄ±r vÉ™ deaktiv edilÉ™nlÉ™ri geri qaytar
                if (outputErrors.length > 0) {
                    e.preventDefault();
                    alert('AÅŸaÄŸÄ±dakÄ± xÉ™talarÄ± dÃ¼zÉ™ldin:\n' + outputErrors.join('\n'));
                    
                    elementsToReEnable.forEach(el => el.disabled = false);
                    
                    return false;
                }
                
                if (!hasValidInput) {
                    e.preventDefault();
                    alert('Æn azÄ± bir xammal (miqdar ilÉ™) daxil edin!');
                    return false;
                }
                
                if (!hasValidOutput) {
                    e.preventDefault();
                    alert('Æn azÄ± bir hazÄ±r mÉ™hsul (miqdar ilÉ™) daxil edin!');
                    return false;
                }

                // Final olaraq, yoxlama zamanÄ± disabled edilmiÅŸ bÃ¼tÃ¼n elementlÉ™ri (boÅŸ sÉ™tirlÉ™r istisna olmaqla) aktiv edirik
                // HÉ™mÃ§inin, submit zamanÄ± yuxarÄ±da disabled edilÉ™n boÅŸ sÉ™tirlÉ™rin disabled vÉ™ziyyÉ™tini qoruyuruq.
                return true;
            });

            document.getElementById('addInputBtn').addEventListener('click', addInputRow);
            document.getElementById('addOutputBtn').addEventListener('click', addOutputRow);

            // BaÅŸlanÄŸÄ±c sÉ™tirlÉ™rini É™lavÉ™ et
            addInputRow();
            addOutputRow();
            addOutputRow();
        });
    </script>
</body>

</html>