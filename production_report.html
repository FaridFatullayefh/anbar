<!doctype html>
<html lang="az">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Ä°stehsalat HesabatÄ±</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .container { padding-top: 20px; }
        .list-unstyled { font-size: 0.9em; }
        .text-danger, .text-success { font-weight: 600; }
        .form-row label { font-weight: 500; font-size: 0.9rem; }
    </style>
</head>
<body>
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Ä°stehsalat ÆmÉ™liyyatlarÄ± HesabatÄ± ğŸ“Š</h2>
        <a href="{{ url_for('export_production_to_excel') }}" class="btn btn-success btn-lg" role="button">
            <i class="fas fa-file-excel"></i> Excel (XLSX) Ä°xrac
        </a>
    </div>
    
    <form class="mb-4 p-3 border rounded bg-light" method="GET" action="{{ url_for('production_report') }}">
        <h5 class="mb-3 text-primary"><i class="fas fa-filter"></i> HesabatÄ± FiltrlÉ™</h5>
        <div class="form-row mb-3">
            <div class="col-md-3 mb-2 mb-md-0">
                <label for="start_date">BaÅŸlanÄŸÄ±c Tarixi:</label>
                <input type="date" id="start_date" name="start_date" class="form-control" value="{{ start_date | default('', true) }}">
            </div>
            <div class="col-md-3 mb-2 mb-md-0">
                <label for="end_date">BitiÅŸ Tarixi:</label>
                <input type="date" id="end_date" name="end_date" class="form-control" value="{{ end_date | default('', true) }}">
            </div>
            
            <div class="col-md-3 mb-2 mb-md-0">
                <label for="input_product_name">Xammal (GiriÅŸ) AdÄ±:</label>
                <input type="text" id="input_product_name" name="input_product_name" class="form-control" placeholder="Xammal adÄ± daxil edin..." value="{{ input_product_name | default('', true) }}">
            </div>
            
            <div class="col-md-3 mb-2 mb-md-0">
                <label for="output_product_name">MÉ™hsul (Ã‡Ä±xÄ±ÅŸ) AdÄ±:</label>
                <input type="text" id="output_product_name" name="output_product_name" class="form-control" placeholder="MÉ™hsul adÄ± daxil edin..." value="{{ output_product_name | default('', true) }}">
            </div>
        </div>
        
        <div class="form-row align-items-end">
            <div class="col-md-9 mb-2 mb-md-0">
                <label for="search_query">ID, AÃ§Ä±qlama, ÆmÉ™liyyatÃ§Ä± AxtarÄ±ÅŸÄ±:</label>
                <input type="search" id="search_query" name="search_query" class="form-control" placeholder="Ãœmumi axtarÄ±ÅŸ (ID, AÃ§Ä±qlama, Ä°ÅŸÃ§i adÄ±)..." value="{{ search_query | default('', true) }}">
            </div>
            <div class="col-md-3">
                <button class="btn btn-primary w-100" type="submit"><i class="fas fa-search"></i> Axtar / Filteri TÉ™tbiq Et</button>
            </div>
        </div>
        
        {% if search_query or start_date or end_date or input_product_name or output_product_name %}
        <div class="form-row mt-2">
            <div class="col">
                <a href="{{ url_for('production_report') }}" class="btn btn-outline-danger btn-sm w-100">
                    <i class="fas fa-redo"></i> BÃ¼tÃ¼n FilterlÉ™ri TÉ™mizlÉ™
                </a>
            </div>
        </div>
        {% endif %}
    </form>
    <p class="text-muted">
        CÉ™mi **{{ pagination.total_items }}** É™mÉ™liyyat tapÄ±ldÄ±. 
        SÉ™hifÉ™: **{{ pagination.current_page }} / {{ pagination.total_pages }}** (HÉ™r sÉ™hifÉ™dÉ™ {{ pagination.per_page }} qeyd)
    </p>
    <hr>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if transfers %}
    
    {% macro render_pagination_link(page_num) %}
        {# BÃ¼tÃ¼n filter parametrlÉ™rini É™l ilÉ™ Ã¶tÃ¼rmÉ™klÉ™ 'do' teqinin istifadÉ™si aradan qaldÄ±rÄ±lÄ±r. #}
        {{ url_for('production_report', 
            page=page_num,
            search_query=search_query,
            start_date=start_date,
            end_date=end_date,
            input_product_name=input_product_name,
            output_product_name=output_product_name
        ) }}
    {% endmacro %}
    
    {% if pagination.total_pages > 1 %}
    <nav aria-label="SÉ™hifÉ™ NaviqasiyasÄ±">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ render_pagination_link(pagination.prev_num) }}">ÆvvÉ™lki</a>
            </li>
            
            {# SadÉ™cÉ™ ilk, son vÉ™ cari sÉ™hifÉ™ É™trafÄ±ndakÄ± sÉ™hifÉ™lÉ™ri gÃ¶stÉ™rmÉ™k Ã¼Ã§Ã¼n #}
            {% set page_range = range(1, pagination.total_pages + 1) %}
            {% for p in page_range %}
                {% if p == 1 or p == pagination.total_pages or (p >= pagination.current_page - 2 and p <= pagination.current_page + 2) %}
                    <li class="page-item {% if p == pagination.current_page %}active{% endif %}">
                        <a class="page-link" href="{{ render_pagination_link(p) }}">{{ p }}</a>
                    </li>
                {% elif (p == pagination.current_page - 3 and pagination.current_page > 3) or (p == pagination.current_page + 3 and pagination.current_page < pagination.total_pages - 2) %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}
            
            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ render_pagination_link(pagination.next_num) }}">NÃ¶vbÉ™ti</a>
            </li>
        </ul>
    </nav>
    {% endif %}

    <div class="table-responsive mt-3">
        <table class="table table-striped table-hover table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th>#ID</th>
                    <th>Tarix</th>
                    <th>ÆmÉ™liyyatÃ§Ä±</th>
                    <th>AÃ§Ä±qlama</th>
                    <th>Xammal (Ä°stifadÉ™ Olunan)</th>
                    <th>MÉ™hsul (Ä°stehsal Olunan)</th>
                </tr>
            </thead>
            <tbody>
                {% for transfer in transfers %}
                <tr>
                    <td>{{ transfer.transfer_id }}</td>
                    <td>{{ transfer.transfer_date }}</td>
                    <td>{{ transfer.employee_name }}</td>
                    <td>{{ transfer.description | default('â€”', true) }}</td>
                    
                    <td>
                        <ul class="list-unstyled mb-0">
                        {# Input ItemlÉ™ri #}
                        {% for item in item_details[transfer.transfer_id]['Input'] %}
                            <li>
                                <strong>{{ item.product_name }}</strong>: 
                                <span class="text-danger"> -{{ item.quantity | round(3) }} {{ item.unit }}</span>
                            </li>
                        {% endfor %}
                        </ul>
                    </td>
                    
                    <td>
                        <ul class="list-unstyled mb-0">
                        {# Output ItemlÉ™ri #}
                        {% for item in item_details[transfer.transfer_id]['Output'] %}
                            <li>
                                <strong>{{ item.product_name }}</strong>: 
                                <span class="text-success"> +{{ item.quantity | round(3) }} {{ item.unit }}</span>
                            </li>
                        {% endfor %}
                        </ul>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if pagination.total_pages > 1 %}
    <nav aria-label="SÉ™hifÉ™ NaviqasiyasÄ±" class="mt-3">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ render_pagination_link(pagination.prev_num) }}">ÆvvÉ™lki</a>
            </li>
            
            {% set page_range = range(1, pagination.total_pages + 1) %}
            {% for p in page_range %}
                {% if p == 1 or p == pagination.total_pages or (p >= pagination.current_page - 2 and p <= pagination.current_page + 2) %}
                    <li class="page-item {% if p == pagination.current_page %}active{% endif %}">
                        <a class="page-link" href="{{ render_pagination_link(p) }}">{{ p }}</a>
                    </li>
                {% elif (p == pagination.current_page - 3 and pagination.current_page > 3) or (p == pagination.current_page + 3 and pagination.current_page < pagination.total_pages - 2) %}
                    <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
            {% endfor %}

            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ render_pagination_link(pagination.next_num) }}">NÃ¶vbÉ™ti</a>
            </li>
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <div class="alert alert-warning" role="alert">
        HeÃ§ bir istehsalat É™mÉ™liyyatÄ± tapÄ±lmadÄ±. ZÉ™hmÉ™t olmasa, axtarÄ±ÅŸ vÉ™ filter ÅŸÉ™rtlÉ™rini yoxlayÄ±n.
    </div>
    {% endif %}

    <a href="{{ url_for('production_form') }}" class="btn btn-secondary mt-4">
        <i class="fas fa-arrow-left"></i> Ä°stehsalat Formuna QayÄ±t
    </a>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>